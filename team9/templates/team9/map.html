<!-- File: team9/templates/team9/map.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Service Map - Team 9</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        /* Right-align popup content for Persian text */
        .leaflet-popup-content { text-align: right; direction: rtl; }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 1. Initialize map centered on Isfahan
        var map = L.map('map').setView([32.6546, 51.6680], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Array to store current markers
        var currentMarkers = [];

        function fetchFacilities() {
            var center = map.getCenter();
            var bounds = map.getBounds();
            var corner = bounds.getNorthEast();
            
            // Calculate view radius in meters
            var radius = Math.floor(map.distance(center, corner));

            // Production API URL (Team 4)
            var apiUrl = `/team4/api/facilities/nearby/?lat=${center.lat}&lng=${center.lng}&radius=${radius}`;

            // --- Mock API URL (For testing only - commented out) ---
            // var apiUrl = '/team9/api/mock-facilities/';

            console.log("Fetching facilities from:", apiUrl);

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    // Clear old markers
                    currentMarkers.forEach(marker => map.removeLayer(marker));
                    currentMarkers = [];

                    // Extract places (Handling both list and object formats)
                    var places = data.results || (Array.isArray(data) ? data : []);

                    places.forEach(place => {
                        // Check if coordinates exist
                        if (place.coordinates && place.coordinates.length === 2) {
                            // JSON: [lng, lat] -> Leaflet: [lat, lng]
                            var lng = place.coordinates[0];
                            var lat = place.coordinates[1];
                            
                            var popupContent = `
                                <b>${place.name_fa}</b><br>
                                <span style="color:gray; font-size:0.9em;">${place.category}</span><br>
                                <span style="font-size:0.8em;">${place.city || ''}</span>
                            `;

                            var marker = L.marker([lat, lng])
                                .addTo(map)
                                .bindPopup(popupContent);
                            
                            currentMarkers.push(marker);
                        }
                    });
                })
                .catch(error => {
                    console.error("Error fetching facilities:", error);
                });
        }

        // Fetch data on move/zoom
        map.on('moveend', fetchFacilities);
        // Initial fetch
        fetchFacilities();
    </script>
</body>
</html>

